<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weather | Auraa (Debug)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #2a003f;
    color: white;
    text-align: center;
    padding: 2rem;
  }
  #weatherIcon {
    font-size: 6rem;
    margin: 1rem 0;
  }
  #message {
    margin-top: 1rem;
    font-weight: bold;
    color: #f0a;
  }
  button {
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    border-radius: 20px;
    background: #7b2cbf;
    color: white;
    cursor: pointer;
    margin-top: 1rem;
  }
  button:hover {
    background: #9d4edd;
  }
  #temperature {
    font-size: 2rem;
    margin: 0.5rem 0;
  }
  #locationName {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
  }
</style>
</head>
<body>
<h1>Current Weather</h1>
<div id="weatherContent">
  <div id="weatherIcon"></div>
  <div id="temperature"></div>
  <div id="description"></div>
  <div id="locationName"></div>
  <div id="weathertext"></div>
</div>
<div id="message">Waiting for location permission...</div>
<button id="retryBtn" style="display:none;">Retry</button>

<script>
  const weatherIcon = document.getElementById('weatherIcon');
  const temperatureEl = document.getElementById('temperature');
  const descriptionEl = document.getElementById('description');
  const locationNameEl = document.getElementById('locationName');
  const messageEl = document.getElementById('message');
  const retryBtn = document.getElementById('retryBtn');

  const weatherCodes = {
    0: "Clear sky",
    1: "Mainly clear",
    2: "Partly cloudy",
    3: "Overcast",
    45: "Fog",
    48: "Depositing rime fog",
    51: "Light drizzle",
    53: "Moderate drizzle",
    55: "Dense drizzle",
    56: "Light freezing drizzle",
    57: "Dense freezing drizzle",
    61: "Slight rain",
    63: "Moderate rain",
    65: "Heavy rain",
    66: "Light freezing rain",
    67: "Heavy freezing rain",
    71: "Slight snow fall",
    73: "Moderate snow fall",
    75: "Heavy snow fall",
    77: "Snow grains",
    80: "Slight rain showers",
    81: "Moderate rain showers",
    82: "Violent rain showers",
    85: "Slight snow showers",
    86: "Heavy snow showers",
    95: "Thunderstorm",
    96: "Thunderstorm with slight hail",
    99: "Thunderstorm with heavy hail"
  };

  function getIconForCode(code) {
    if ([0,1].includes(code)) return '☀️';       
    if ([2,3].includes(code)) return '⛅';       
    if ([45,48].includes(code)) return '🌫️';   
    if ([51,53,55,56,57].includes(code)) return '🌧️'; 
    if ([61,63,65,66,67,80,81,82].includes(code)) return '🌦️'; 
    if ([71,73,75,77,85,86].includes(code)) return '❄️'; 
    if ([95,96,99].includes(code)) return '⛈️'; 
    return '❓';
  }

  // Convert Celsius to Fahrenheit
  function celsiusToFahrenheit(c) {
    return (c * 9/5) + 32;
  }

  // Determine if it is night based on user's local time at their location (using timezone offset from geolocation API)
  // We approximate night as between 7 PM and 6 AM local time
  function isNight(date) {
    const hour = date.getHours();
    return (hour >= 19 || hour < 6);
  }

  function fetchWeather(lat, lon) {
    messageEl.textContent = 'Fetching weather data...';
    locationNameEl.textContent = ''; // Clear previous location
    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;

    fetch(weatherUrl)
      .then(response => {
        if (!response.ok) throw new Error('Weather fetch failed: ' + response.status);
        return response.json();
      })
      .then(data => {
        if (!data.current_weather) throw new Error('No current weather data received');
        const current = data.current_weather;

        const celsius = current.temperature.toFixed(1);
        const fahrenheit = celsiusToFahrenheit(current.temperature).toFixed(1);

        // Determine if it's night based on current time in user's timezone (auto timezone from API)
        // data.current_weather.time is in ISO string format like "2023-07-03T13:00"
        const currentTime = new Date(current.time);
        const night = isNight(currentTime);

        const dayNightIcon = night ? '🌙' : '☀️';

        temperatureEl.textContent = `${dayNightIcon} ${celsius}°C / ${fahrenheit}°F`;
        descriptionEl.textContent = weatherCodes[current.weathercode] || 'Unknown weather';
        weatherIcon.textContent = getIconForCode(current.weathercode);

        messageEl.textContent = 'Fetching location name...';

        // Reverse geocode to get human-readable location name
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
          .then(resp => {
            if (!resp.ok) throw new Error('Failed to get location name');
            return resp.json();
          })
          .then(locData => {
            let displayName = locData.address.city 
              || locData.address.town 
              || locData.address.village 
              || locData.address.county 
              || locData.address.state 
              || locData.address.country 
              || 'Unknown location';

            locationNameEl.textContent = `Location: ${displayName}`;
            messageEl.textContent = 'Weather updated successfully!';
          })
          .catch(() => {
            locationNameEl.textContent = `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`;
            messageEl.textContent = 'Weather updated (location name not available)';
          });

        retryBtn.style.display = 'none';
      })
      .catch(err => {
        messageEl.textContent = 'Error fetching weather data: ' + err.message;
        retryBtn.style.display = 'inline-block';
        console.error(err);
      });
  }

  function requestLocation() {
    if (!navigator.geolocation) {
      messageEl.textContent = 'Geolocation is not supported by your browser.';
      retryBtn.style.display = 'none';
      return;
    }

    messageEl.textContent = 'Requesting location permission...';
    retryBtn.style.display = 'none';

    navigator.geolocation.getCurrentPosition(
      position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        fetchWeather(lat, lon);
      },
      error => {
        let errorMsg = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = 'Permission denied. Please allow location access.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = 'Position unavailable.';
            break;
          case error.TIMEOUT:
            errorMsg = 'Location request timed out.';
            break;
          default:
            errorMsg = 'An unknown error occurred.';
        }
        messageEl.textContent = errorMsg;
        retryBtn.style.display = 'inline-block';
        console.error(error);
      },
      {timeout: 15000}
    );
  }

  retryBtn.addEventListener('click', () => {
    temperatureEl.textContent = '';
    descriptionEl.textContent = '';
    weatherIcon.textContent = '';
    locationNameEl.textContent = '';
    messageEl.textContent = '';
    requestLocation();
  });

  window.onload = requestLocation;
</script>
</body>
</html>
