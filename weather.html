<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather | Auraa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2a003f;
      color: white;
      text-align: center;
      padding: 2rem;
    }
    #weatherIcon {
      font-size: 6rem;
      margin: 1rem 0;
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
      color: #f0a;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 20px;
      background: #7b2cbf;
      color: white;
      cursor: pointer;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #9d4edd;
    }
    #temperature, #feelsLike, #wind {
      font-size: 1.2rem;
      margin: 0.5rem 0;
    }
    #locationName {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .top-bar {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    .top-bar button {
      font-size: 0.9rem;
      padding: 8px 16px;
    }
    #forecast {
      margin-top: 2rem;
    }
    .forecast-day {
      display: inline-block;
      background: #3a005f;
      border-radius: 12px;
      margin: 0.5rem;
      padding: 1rem;
      width: 120px;
    }
    .forecast-day h4 {
      margin: 0.3rem 0;
      font-size: 1rem;
    }
    .forecast-day span {
      font-size: 2rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button onclick="window.location.href='index.html'">‚Üê Back to Homepage</button>
  </div>

  <h1>Current Weather</h1>
  <div id="weatherContent">
    <div id="weatherIcon"></div>
    <div id="temperature"></div>
    <div id="feelsLike"></div>
    <div id="wind"></div>
    <div id="description"></div>
    <div id="locationName"></div>
  </div>
  <div id="message">Waiting for location permission...</div>
  <button id="retryBtn" style="display:none;">Retry</button>

  <div id="forecast">
    <h2>7-Day Forecast</h2>
    <div id="forecastDays"></div>
  </div>

  <script>
    const weatherIcon = document.getElementById('weatherIcon');
    const temperatureEl = document.getElementById('temperature');
    const feelsLikeEl = document.getElementById('feelsLike');
    const windEl = document.getElementById('wind');
    const descriptionEl = document.getElementById('description');
    const locationNameEl = document.getElementById('locationName');
    const messageEl = document.getElementById('message');
    const retryBtn = document.getElementById('retryBtn');
    const forecastDaysEl = document.getElementById('forecastDays');

    const weatherCodes = {
      0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
      45: "Fog", 48: "Depositing rime fog", 51: "Light drizzle", 53: "Moderate drizzle",
      55: "Dense drizzle", 56: "Light freezing drizzle", 57: "Dense freezing drizzle",
      61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain",
      66: "Light freezing rain", 67: "Heavy freezing rain",
      71: "Slight snow fall", 73: "Moderate snow fall", 75: "Heavy snow fall",
      77: "Snow grains", 80: "Slight rain showers", 81: "Moderate rain showers",
      82: "Violent rain showers", 85: "Slight snow showers", 86: "Heavy snow showers",
      95: "Thunderstorm", 96: "Thunderstorm with slight hail", 99: "Thunderstorm with heavy hail"
    };

    function getIconForCode(code, isNight) {
      if ([0, 1].includes(code)) return isNight ? 'üåô' : '‚òÄÔ∏è';
      if ([2, 3].includes(code)) return '‚õÖ';
      if ([45, 48].includes(code)) return 'üå´Ô∏è';
      if ([51, 53, 55, 56, 57].includes(code)) return 'üåßÔ∏è';
      if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return 'üå¶Ô∏è';
      if ([71, 73, 75, 77, 85, 86].includes(code)) return '‚ùÑÔ∏è';
      if ([95, 96, 99].includes(code)) return '‚õàÔ∏è';
      return '‚ùì';
    }

    function celsiusToFahrenheit(c) {
      return (c * 9 / 5) + 32;
    }

    function getTimeMessage(hour) {
      if (hour === 0) return "It's midnight!";
      if (hour <= 4) return `It's ${hour} AM...`;
      if (hour <= 11) return "Good morning!";
      if (hour === 12) return "It's noon!";
      if (hour <= 16) return "Good afternoon!";
      if (hour <= 20) return "Good evening!";
      return "Good night!";
    }

    function fetchWeather(lat, lon) {
      messageEl.textContent = 'Fetching weather data...';
      locationNameEl.textContent = '';

      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&hourly=apparent_temperature,windspeed_10m&timezone=auto`;

      fetch(weatherUrl)
        .then(response => {
          if (!response.ok) throw new Error('Weather fetch failed');
          return response.json();
        })
        .then(data => {
          const current = data.current_weather;
          const hourIndex = data.hourly.time.findIndex(t => t === current.time);
          const feelsLike = data.hourly.apparent_temperature[hourIndex];
          const windSpeed = current.windspeed;

          const celsius = current.temperature.toFixed(1);
          const fahrenheit = celsiusToFahrenheit(current.temperature).toFixed(1);
          const feelsC = feelsLike.toFixed(1);
          const feelsF = celsiusToFahrenheit(feelsLike).toFixed(1);

          const currentTime = new Date(current.time);
          const hour = currentTime.getHours();
          const isNight = hour >= 19 || hour < 6;

          weatherIcon.textContent = getIconForCode(current.weathercode, isNight);
          temperatureEl.textContent = `Temperature: ${celsius}¬∞C / ${fahrenheit}¬∞F`;
          feelsLikeEl.textContent = `Feels like: ${feelsC}¬∞C / ${feelsF}¬∞F`;
          windEl.textContent = `Wind Speed: ${windSpeed} km/h`;
          descriptionEl.textContent = getTimeMessage(hour);
          retryBtn.style.display = 'none';

          // Location reverse geocoding
          messageEl.textContent = 'Fetching location name...';
          fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
            .then(resp => resp.ok ? resp.json() : Promise.reject())
            .then(locData => {
              const name = locData.address.city || locData.address.town || locData.address.village ||
                locData.address.county || locData.address.state || locData.address.country || 'Unknown';
              locationNameEl.textContent = `Location: ${name}`;
              messageEl.textContent = 'Weather updated!';
            })
            .catch(() => {
              locationNameEl.textContent = `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`;
              messageEl.textContent = 'Weather updated (location name unavailable)';
            });

          // 7-day forecast
          forecastDaysEl.innerHTML = '';
          for (let i = 0; i < 7; i++) {
            const date = new Date(data.daily.time[i]);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const icon = getIconForCode(data.daily.weathercode[i], false);
            const max = data.daily.temperature_2m_max[i].toFixed(0);
            const min = data.daily.temperature_2m_min[i].toFixed(0);

            forecastDaysEl.innerHTML += `
              <div class="forecast-day">
                <h4>${dayName}</h4>
                <span>${icon}</span>
                <h4>${min}¬∞ / ${max}¬∞C</h4>
              </div>
            `;
          }
        })
        .catch(err => {
          messageEl.textContent = 'Error: ' + err.message;
          retryBtn.style.display = 'inline-block';
        });
    }

    function requestLocation() {
      if (!navigator.geolocation) {
        messageEl.textContent = 'Geolocation not supported.';
        return;
      }

      messageEl.textContent = 'Requesting location...';
      navigator.geolocation.getCurrentPosition(
        pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
        err => {
          messageEl.textContent = 'Location error: ' + err.message;
          retryBtn.style.display = 'inline-block';
        },
        { timeout: 15000 }
      );
    }

    retryBtn.addEventListener('click', () => {
      temperatureEl.textContent = '';
      feelsLikeEl.textContent = '';
      windEl.textContent = '';
      descriptionEl.textContent = '';
      weatherIcon.textContent = '';
      locationNameEl.textContent = '';
      forecastDaysEl.innerHTML = '';
      messageEl.textContent = '';
      requestLocation();
    });

    window.onload = requestLocation;
  </script>
</body>
</html>
