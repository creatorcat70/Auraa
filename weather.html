<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather | Auraa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2a003f;
      color: white;
      text-align: center;
      padding: 2rem;
    }
    #weatherIcon {
      font-size: 6rem;
      margin: 1rem 0;
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
      color: #f0a;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 20px;
      background: #7b2cbf;
      color: white;
      cursor: pointer;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #9d4edd;
    }
    #temperature, #feelsLike, #windSpeed {
      font-size: 1.2rem;
      margin: 0.4rem 0;
    }
    #locationName {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    #locationFlag {
      font-size: 1.8rem;
    }
    .top-bar {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    .top-bar button {
      font-size: 0.9rem;
      padding: 8px 16px;
    }
    .forecast {
      margin-top: 2rem;
    }
    .day {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button onclick="window.location.href='index.html'">‚Üê Back to Homepage</button>
  </div>
  <h1>Current Weather</h1>
  <div id="weatherContent">
    <div id="weatherIcon"></div>
    <div id="temperature"></div>
    <div id="feelsLike"></div>
    <div id="windSpeed"></div>
    <div id="description"></div>
    <div id="locationName"><span id="locationFlag"></span><span id="locationText"></span></div>
    <button id="unitToggle">Switch to Celsius</button>
  </div>
  <div id="message">Waiting for location permission...</div>
  <button id="retryBtn" style="display:none;">Retry</button>
  <div class="forecast">
    <h2>7-Day Forecast</h2>
    <div id="forecastDays"></div>
  </div>
  <script>
    const weatherIcon = document.getElementById('weatherIcon');
    const temperatureEl = document.getElementById('temperature');
    const feelsLikeEl = document.getElementById('feelsLike');
    const windSpeedEl = document.getElementById('windSpeed');
    const descriptionEl = document.getElementById('description');
    const locationFlagEl = document.getElementById('locationFlag');
    const locationTextEl = document.getElementById('locationText');
    const messageEl = document.getElementById('message');
    const retryBtn = document.getElementById('retryBtn');
    const forecastDaysEl = document.getElementById('forecastDays');
    const unitToggle = document.getElementById('unitToggle');

    let isFahrenheit = true;
    let currentWeather = {};
    let forecastData = [];

    const weatherCodes = {
      0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
      45: "Fog", 48: "Rime fog", 51: "Light drizzle", 53: "Moderate drizzle",
      55: "Dense drizzle", 56: "Light freezing drizzle", 57: "Dense freezing drizzle",
      61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain",
      66: "Light freezing rain", 67: "Heavy freezing rain",
      71: "Slight snowfall", 73: "Moderate snowfall", 75: "Heavy snowfall",
      77: "Snow grains", 80: "Light rain showers", 81: "Moderate rain showers",
      82: "Heavy rain showers", 85: "Light snow showers", 86: "Heavy snow showers",
      95: "Thunderstorm", 96: "Thunderstorm with slight hail", 99: "Thunderstorm with heavy hail"
    };

    function getIconForCode(code, isNight) {
      if ([0,1].includes(code)) return isNight ? 'üåô' : '‚òÄÔ∏è';
      if ([2,3].includes(code)) return '‚õÖ';
      if ([45,48].includes(code)) return 'üå´Ô∏è';
      if ([51,53,55,56,57].includes(code)) return 'üåßÔ∏è';
      if ([61,63,65,66,67,80,81,82].includes(code)) return 'üå¶Ô∏è';
      if ([71,73,75,77,85,86].includes(code)) return '‚ùÑÔ∏è';
      if ([95,96,99].includes(code)) return '‚õàÔ∏è';
      return '‚ùì';
    }

    function cToF(c) {
      return (c * 9 / 5) + 32;
    }

    function getTimeMessage(hour) {
      if (hour === 0) return "It's midnight!";
      if (hour >= 1 && hour <= 4) return `It's ${hour} AM...`;
      if (hour >= 5 && hour <= 11) return "Good morning!";
      if (hour === 12) return "It's noon!";
      if (hour >= 13 && hour <= 16) return "Good afternoon!";
      if (hour >= 17 && hour <= 20) return "Good evening!";
      if (hour >= 21 && hour <= 23) return "Good night!";
      return "";
    }

    function countryCodeToFlagEmoji(countryCode) {
      if (!countryCode) return '';
      return countryCode.toUpperCase()
        .replace(/./g, char => 
          String.fromCodePoint(127397 + char.charCodeAt())
        );
    }

    function renderWeather() {
      const temp = isFahrenheit ? `${cToF(currentWeather.temp).toFixed(1)}¬∞F` : `${currentWeather.temp.toFixed(1)}¬∞C`;
      const feels = isFahrenheit ? `${cToF(currentWeather.temp).toFixed(1)}¬∞F` : `${currentWeather.temp.toFixed(1)}¬∞C`;
      temperatureEl.textContent = `üå°Ô∏è ${temp}`;
      feelsLikeEl.textContent = `Feels like: ${feels}`;
      windSpeedEl.textContent = `Wind: ${currentWeather.wind} m/s`;
      descriptionEl.textContent = currentWeather.description;
      weatherIcon.textContent = currentWeather.icon;

      forecastDaysEl.innerHTML = '';
      forecastData.forEach(day => {
        const min = isFahrenheit ? `${cToF(day.min).toFixed(1)}¬∞F` : `${day.min.toFixed(1)}¬∞C`;
        const max = isFahrenheit ? `${cToF(day.max).toFixed(1)}¬∞F` : `${day.max.toFixed(1)}¬∞C`;
        forecastDaysEl.innerHTML += `<div class="day">${day.label}: ${day.icon} ${min} - ${max}</div>`;
      });

      unitToggle.textContent = isFahrenheit ? 'Switch to Celsius' : 'Switch to Fahrenheit';
    }

    unitToggle.addEventListener('click', () => {
      isFahrenheit = !isFahrenheit;
      renderWeather();
    });

    function fetchWeather(lat, lon) {
      messageEl.textContent = 'Fetching weather data...';
      locationFlagEl.textContent = '';
      locationTextEl.textContent = '';
      forecastDaysEl.innerHTML = '';
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&wind_speed_unit=ms`;
      fetch(url).then(res => res.json()).then(data => {
        const current = data.current_weather;
        const daily = data.daily;
        const celsius = current.temperature;
        const wind = current.windspeed.toFixed(1);
        const hour = new Date(current.time).getHours();
        const isNight = hour >= 19 || hour < 6;

        currentWeather = {
          temp: celsius,
          wind: wind,
          icon: getIconForCode(current.weathercode, isNight),
          description: getTimeMessage(hour)
        };

        forecastData = [];
        for (let i = 0; i < 7; i++) {
          forecastData.push({
            label: i === 0 ? "Today" : new Date(daily.time[i]).toLocaleDateString(undefined, { weekday: 'short' }),
            min: daily.temperature_2m_min[i],
            max: daily.temperature_2m_max[i],
            icon: getIconForCode(daily.weathercode[i], false)
          });
        }

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
          .then(res => res.json()).then(loc => {
            const countryCode = loc.address.country_code || '';
            const flag = countryCodeToFlagEmoji(countryCode);
            locationFlagEl.textContent = flag;

            // Show city/town/village or fallback to state/province or country
            const place = loc.address.city || loc.address.town || loc.address.village || loc.address.state || loc.address.country || 'Unknown';
            locationTextEl.textContent = place;

            messageEl.textContent = 'Weather updated!';
            renderWeather();
          }).catch(() => {
            locationFlagEl.textContent = '';
            locationTextEl.textContent = `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`;
            messageEl.textContent = 'Weather updated (location name unavailable)';
            renderWeather();
          });

        retryBtn.style.display = 'none';
      }).catch(err => {
        messageEl.textContent = 'Error: ' + err.message;
        retryBtn.style.display = 'inline-block';
      });
    }

    function requestLocation() {
      if (!navigator.geolocation) {
        messageEl.textContent = 'Geolocation not supported.';
        return;
      }
      messageEl.textContent = 'Requesting location...';
      navigator.geolocation.getCurrentPosition(
        pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
        err => {
          messageEl.textContent = 'Please allow location access. We do not use or store your location and respect your privacy.';
          retryBtn.style.display = 'inline-block';
        },
        { timeout: 15000 }
      );
    }

    retryBtn.addEventListener('click', () => {
      weatherIcon.textContent = '';
      temperatureEl.textContent = '';
      feelsLikeEl.textContent = '';
      windSpeedEl.textContent = '';
      descriptionEl.textContent = '';
      locationFlagEl.textContent = '';
      locationTextEl.textContent = '';
      messageEl.textContent = '';
      forecastDaysEl.innerHTML = '';
      requestLocation();
    });

    window.onload = requestLocation;
  </script>
</body>
</html>
